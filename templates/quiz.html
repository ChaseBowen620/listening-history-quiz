{% extends "base.html" %}

{% block title %}Quiz - Listening History Quiz{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="text-center mb-4">
            <h2>Welcome, {{ user_name }}!</h2>
            {% if is_multiplayer %}
            <div class="alert alert-info">
                <i class="fas fa-users me-2"></i><strong>Multiplayer Mode</strong> - Competing with other players!
            </div>
            {% else %}
            <p class="text-muted">Test your knowledge of your own music taste!</p>
            {% endif %}
        </div>

        <div class="card shadow-lg">
            <div class="card-body p-4">
                <div id="quiz-container">
                    <div id="loading" class="text-center py-5">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Generating personalized questions...</p>
                    </div>

                    <div id="quiz-questions" style="display: none;">
                        <div class="progress mb-4">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="progress-bar"></div>
                        </div>

                        <div id="question-container">
                            <!-- Questions will be loaded here -->
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-secondary" id="prev-btn" style="display: none;">
                                <i class="fas fa-arrow-left me-2"></i>Previous
                            </button>
                            <button type="button" class="btn btn-success" id="next-btn">
                                Next<i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.drag-item {
    padding: 12px;
    margin: 8px 0;
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    cursor: move;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 12px;
}

.drag-item:hover {
    background: #e9ecef;
    border-color: #0d6efd;
}

.drag-item.dragging {
    opacity: 0.5;
}

.drag-item img {
    width: 50px;
    height: 50px;
    border-radius: 4px;
    object-fit: cover;
}

.fill-blank-image {
    max-width: 300px;
    border-radius: 8px;
    margin: 20px auto;
    display: block;
}

.placement-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.placement-option {
    padding: 15px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.placement-option:hover {
    border-color: #0d6efd;
    background: #f0f7ff;
}

.placement-option.selected {
    border-color: #0d6efd;
    background: #e7f3ff;
}

.placement-option img {
    width: 100px;
    height: 100px;
    border-radius: 8px;
    margin-bottom: 10px;
    object-fit: cover;
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
let currentQuestion = 0;
let answers = {};
let questions = [];
const lobbyId = '{{ lobby_id }}' || null;
const isMultiplayer = {{ 'true' if is_multiplayer else 'false' }};
let questionAnswered = {};
let waitingForOthers = false;
let selectedPlayers = [];

// Load quiz questions from templates
async function loadQuiz() {
    try {
        const url = lobbyId 
            ? `/api/quiz-questions?lobby=${lobbyId}`
            : '/api/quiz-questions';
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ lobby_id: lobbyId })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to generate questions');
        }
        
        const data = await response.json();
        questions = data.questions;
        if (data.selected_players) {
            selectedPlayers = data.selected_players;
        }
        
        if (questions.length === 0) {
            throw new Error('No questions generated');
        }
        
        // Show selected players announcement if multiplayer
        if (isMultiplayer && selectedPlayers.length > 0) {
            showSelectedPlayers();
        } else {
            showQuestion(0);
        }
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('quiz-questions').style.display = 'block';
    } catch (error) {
        console.error('Error loading quiz:', error);
        document.getElementById('loading').innerHTML = 
            '<div class="alert alert-danger">' +
            '<h5>Failed to generate questions</h5>' +
            '<p>' + error.message + '</p>' +
            '<button class="btn btn-primary mt-2" onclick="location.reload()">Try Again</button>' +
            '</div>';
    }
}

function showSelectedPlayers() {
    const container = document.getElementById('question-container');
    container.innerHTML = `
        <div class="alert alert-info text-center">
            <h4><i class="fas fa-users me-2"></i>Selected Players</h4>
            <p class="mb-2">Questions will be based on data from:</p>
            <ul class="list-unstyled">
                ${selectedPlayers.map(p => `<li><strong>${p}</strong></li>`).join('')}
            </ul>
            <button class="btn btn-primary mt-3" onclick="showQuestion(0)">Start Quiz</button>
        </div>
    `;
}

function showQuestion(index) {
    const question = questions[index];
    const container = document.getElementById('question-container');
    
    let html = `<div class="question">`;
    html += `<h4 class="mb-4">${question.question}</h4>`;
    
    // Handle different question types
    switch(question.type) {
        case 'placement':
            html += renderPlacementQuestion(question);
            break;
        case 'true_false':
            html += renderTrueFalseQuestion(question);
            break;
        case 'drag_drop':
            html += renderDragDropQuestion(question);
            break;
        case 'fill_blank':
            html += renderFillBlankQuestion(question);
            break;
        case 'multiple_choice':
            html += renderMultipleChoiceQuestion(question);
            break;
        default:
            html += `<p class="text-danger">Unknown question type: ${question.type}</p>`;
    }
    
    html += `</div>`;
    container.innerHTML = html;
    
    // Initialize drag-drop if needed
    if (question.type === 'drag_drop') {
        initializeDragDrop(question.id);
    }
    
    // Update progress
    const progress = ((index + 1) / questions.length) * 100;
    document.getElementById('progress-bar').style.width = progress + '%';
    
    // Update navigation buttons
    document.getElementById('prev-btn').style.display = index > 0 ? 'block' : 'none';
    document.getElementById('next-btn').textContent = index === questions.length - 1 ? 'Finish Quiz' : 'Next';
    
    currentQuestion = index;
}

function renderPlacementQuestion(question) {
    let html = '<div class="placement-options">';
    const options = question.options || [];
    const currentAnswer = answers[question.id];
    
    options.forEach((option, i) => {
        const isSelected = currentAnswer === option;
        html += `
            <div class="placement-option ${isSelected ? 'selected' : ''}" 
                 onclick="selectPlacement('${question.id}', '${option.replace(/'/g, "\\'")}')">
                ${question.data && question.data.image_urls && question.data.image_urls[option] 
                    ? `<img src="${question.data.image_urls[option]}" alt="${option}" onerror="this.style.display='none'">` 
                    : ''}
                <div><strong>${option}</strong></div>
            </div>
        `;
    });
    html += '</div>';
    return html;
}

function renderTrueFalseQuestion(question) {
    const currentAnswer = answers[question.id];
    return `
        <div class="d-flex gap-3 justify-content-center mt-4">
            <button class="btn btn-lg ${currentAnswer === 'true' ? 'btn-primary' : 'btn-outline-primary'}" 
                    onclick="selectTrueFalse('${question.id}', 'true')">
                True
            </button>
            <button class="btn btn-lg ${currentAnswer === 'false' ? 'btn-primary' : 'btn-outline-primary'}" 
                    onclick="selectTrueFalse('${question.id}', 'false')">
                False
            </button>
        </div>
    `;
}

function renderDragDropQuestion(question) {
    const items = question.data?.items || [];
    const currentOrder = answers[question.id] || items.map((item, i) => i);
    const isAnswered = questionAnswered[question.id] || false;
    
    let html = '<div class="mt-4">';
    html += '<p class="text-muted mb-3">Drag items to reorder them:</p>';
    html += `<div id="drag-list-${question.id}" class="drag-list">`;
    
    currentOrder.forEach((idx) => {
        const item = items[idx];
        html += `
            <div class="drag-item" data-index="${idx}">
                ${item.image_url ? `<img src="${item.image_url}" alt="${item.name}" onerror="this.style.display='none'">` : ''}
                <div>
                    <strong>${item.name}</strong>
                    ${item.artist ? `<div class="text-muted small">${item.artist}</div>` : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    if (!isAnswered && isMultiplayer) {
        html += '<button class="btn btn-success w-100 mt-3" onclick="submitCurrentAnswer()">Submit Answer</button>';
    }
    html += '</div>';
    return html;
}

function renderFillBlankQuestion(question) {
    const currentAnswer = answers[question.id] || '';
    const imageUrl = question.data?.image_url;
    const isAnswered = questionAnswered[question.id] || false;
    
    let html = '<div class="mt-4">';
    if (imageUrl) {
        html += `<img src="${imageUrl}" alt="Playlist/Album image" class="fill-blank-image" onerror="this.style.display='none'">`;
    }
    html += `
        <div class="mt-3">
            <input type="text" 
                   class="form-control form-control-lg text-center" 
                   id="fill-blank-${question.id}"
                   placeholder="Enter your answer..."
                   value="${currentAnswer}"
                   ${isAnswered ? 'disabled' : ''}
                   onchange="saveFillBlank('${question.id}')">
        </div>
    `;
    if (!isAnswered && isMultiplayer) {
        html += '<button class="btn btn-success w-100 mt-3" onclick="submitCurrentAnswer()">Submit Answer</button>';
    }
    html += '</div>';
    return html;
}

function renderMultipleChoiceQuestion(question) {
    const options = question.options || [];
    const currentAnswer = answers[question.id];
    const isAnswered = questionAnswered[question.id] || false;
    
    let html = '<div class="mt-4">';
    options.forEach((option, i) => {
        const checked = currentAnswer === option ? 'checked' : '';
        const disabled = isAnswered ? 'disabled' : '';
        html += `
            <div class="form-check mb-3 p-3 border rounded">
                <input class="form-check-input" type="radio" 
                       name="${question.id}" 
                       id="${question.id}_${i}" 
                       value="${option}" 
                       ${checked}
                       ${disabled}
                       onchange="saveAnswer('${question.id}', '${option.replace(/'/g, "\\'")}'); handleAnswer('${question.id}', '${option.replace(/'/g, "\\'")}')">
                <label class="form-check-label" for="${question.id}_${i}">
                    ${option}
                </label>
            </div>
        `;
    });
    if (!isAnswered && isMultiplayer) {
        html += '<button class="btn btn-success w-100 mt-3" onclick="submitCurrentAnswer()">Submit Answer</button>';
    }
    html += '</div>';
    return html;
}

function submitCurrentAnswer() {
    const question = questions[currentQuestion];
    const answer = answers[question.id];
    if (answer !== undefined && answer !== '') {
        handleAnswer(question.id, answer);
    }
}

function selectPlacement(questionId, value) {
    answers[questionId] = value;
    showQuestion(currentQuestion); // Refresh to show selection
    handleAnswer(questionId, value);
}

function selectTrueFalse(questionId, value) {
    answers[questionId] = value;
    showQuestion(currentQuestion); // Refresh to show selection
    handleAnswer(questionId, value);
}

function handleAnswer(questionId, answer) {
    const question = questions.find(q => q.id === questionId);
    if (!question) return;
    
    const isCorrect = checkAnswer(question, answer);
    
    if (isMultiplayer) {
        // Submit answer and wait for others
        submitQuestionAnswer(questionId, answer, isCorrect);
    } else {
        // Solo mode - immediate feedback
        showFeedback(isCorrect);
    }
}

function checkAnswer(question, answer) {
    const correct = question.correct_answer;
    if (question.type === 'drag_drop') {
        const userOrder = Array.isArray(answer) ? answer : JSON.parse(answer || '[]');
        const correctOrder = question.data?.correct_order || [];
        return JSON.stringify(userOrder) === JSON.stringify(correctOrder);
    } else if (question.type === 'true_false') {
        return String(answer).toLowerCase() === String(correct).toLowerCase();
    } else {
        return String(answer).trim().toLowerCase() === String(correct).trim().toLowerCase();
    }
}

function showFeedback(isCorrect) {
    const overlay = document.createElement('div');
    overlay.className = `feedback-overlay ${isCorrect ? 'correct' : 'incorrect'}`;
    overlay.innerHTML = `
        <div class="feedback-content">
            <i class="fas fa-${isCorrect ? 'check-circle' : 'times-circle'} fa-3x mb-3"></i>
            <div>${isCorrect ? 'Correct!' : 'Incorrect'}</div>
        </div>
    `;
    document.body.appendChild(overlay);
    setTimeout(() => overlay.classList.add('show'), 10);
    setTimeout(() => {
        overlay.classList.remove('show');
        setTimeout(() => overlay.remove(), 300);
    }, 1500);
}

async function submitQuestionAnswer(questionId, answer, isCorrect) {
    if (!lobbyId) return;
    
    try {
        await fetch(`/api/lobby/${lobbyId}/submit-answer`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                question_id: questionId,
                answer: answer,
                question_index: currentQuestion
            })
        });
        
        questionAnswered[questionId] = true;
        checkQuestionStatus();
    } catch (error) {
        console.error('Error submitting answer:', error);
    }
}

async function checkQuestionStatus() {
    if (!lobbyId) return;
    
    const response = await fetch(`/api/lobby/${lobbyId}/question-status`);
    const data = await response.json();
    
    const total = data.total_participants;
    const answered = data.answered;
    
    if (answered >= total) {
        // Everyone answered - reveal answer and show leaderboard
        revealAnswerAndLeaderboard();
    } else {
        // Show waiting overlay
        showWaitingOverlay(answered, total);
    }
}

function showWaitingOverlay(answered, total) {
    if (waitingForOthers) return;
    waitingForOthers = true;
    
    const overlay = document.createElement('div');
    overlay.className = 'waiting-overlay';
    overlay.id = 'waiting-overlay';
    overlay.innerHTML = `
        <div>
            <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
            <h3>Waiting for other players...</h3>
            <p>${answered} of ${total} players answered</p>
        </div>
    `;
    document.body.appendChild(overlay);
    
    // Poll every second
    const pollInterval = setInterval(async () => {
        const statusResponse = await fetch(`/api/lobby/${lobbyId}/question-status`);
        const statusData = await statusResponse.json();
        
        if (statusData.answered >= statusData.total_participants) {
            clearInterval(pollInterval);
            revealAnswerAndLeaderboard();
        } else {
            overlay.querySelector('p').textContent = `${statusData.answered} of ${statusData.total_participants} players answered`;
        }
    }, 1000);
    
    // Timeout after 15 seconds
    setTimeout(() => {
        clearInterval(pollInterval);
        revealAnswerAndLeaderboard();
    }, 15000);
}

async function revealAnswerAndLeaderboard() {
    waitingForOthers = false;
    const overlay = document.getElementById('waiting-overlay');
    if (overlay) overlay.remove();
    
    const question = questions[currentQuestion];
    const userAnswer = answers[question.id];
    const isCorrect = checkAnswer(question, userAnswer);
    
    // Show feedback
    showFeedback(isCorrect);
    
    // Get and show leaderboard
    const leaderboardResponse = await fetch(`/api/lobby/${lobbyId}/leaderboard`);
    const leaderboardData = await leaderboardResponse.json();
    showQuestionLeaderboard(leaderboardData.leaderboard, question, isCorrect);
}

function showQuestionLeaderboard(leaderboard, question, isCorrect) {
    const container = document.getElementById('question-container');
    const leaderboardHtml = `
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Leaderboard</h5>
            </div>
            <div class="card-body leaderboard-mini">
                <ol class="list-group list-group-numbered">
                    ${leaderboard.map((p, i) => `
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">${p.game_name}</div>
                            </div>
                            <span class="badge bg-success rounded-pill">${p.score} pts</span>
                        </li>
                    `).join('')}
                </ol>
            </div>
        </div>
        <div class="alert ${isCorrect ? 'alert-success' : 'alert-danger'}">
            <strong>Your answer:</strong> ${getAnswerDisplay(question, answers[question.id])}<br>
            <strong>Correct answer:</strong> ${getAnswerDisplay(question, question.correct_answer)}
        </div>
        <button class="btn btn-primary w-100" onclick="nextQuestion()">Next Question</button>
    `;
    
    container.innerHTML = leaderboardHtml;
}

function getAnswerDisplay(question, answer) {
    if (question.type === 'drag_drop') {
        return 'Ordered list';
    }
    return answer || 'No answer';
}

function saveFillBlank(questionId) {
    const input = document.getElementById(`fill-blank-${questionId}`);
    answers[questionId] = input.value.trim();
}

function saveAnswer(questionId, value) {
    answers[questionId] = value;
}

function initializeDragDrop(questionId) {
    const list = document.getElementById(`drag-list-${questionId}`);
    if (!list) return;
    
    new Sortable(list, {
        animation: 150,
        handle: '.drag-item',
        onEnd: function(evt) {
            const items = Array.from(list.children);
            const order = items.map(item => parseInt(item.dataset.index));
            answers[questionId] = order;
        }
    });
}

function nextQuestion() {
    if (isMultiplayer && lobbyId) {
        // Move to next question in multiplayer
        fetch(`/api/lobby/${lobbyId}/next-question`, { method: 'POST' })
            .then(() => {
                if (currentQuestion < questions.length - 1) {
                    currentQuestion++;
                    showQuestion(currentQuestion);
                } else {
                    submitQuiz();
                }
            });
    } else {
        if (currentQuestion < questions.length - 1) {
            showQuestion(currentQuestion + 1);
        } else {
            submitQuiz();
        }
    }
}

function prevQuestion() {
    if (currentQuestion > 0) {
        showQuestion(currentQuestion - 1);
    }
}

async function submitQuiz() {
    // Validate all questions answered
    const unanswered = questions.filter(q => !answers[q.id] || answers[q.id] === '');
    if (unanswered.length > 0) {
        if (!confirm(`You have ${unanswered.length} unanswered question(s). Submit anyway?`)) {
            return;
        }
    }
    
    try {
        const response = await fetch('/submit-quiz', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                answers: answers,
                lobby_id: lobbyId
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to submit quiz');
        }
        
        const results = await response.json();
        const resultsUrl = lobbyId 
            ? `/results?lobby=${lobbyId}`
            : '/results';
        window.location.href = resultsUrl;
        
    } catch (error) {
        console.error('Error submitting quiz:', error);
        alert('Failed to submit quiz. Please try again.');
    }
}

// Event listeners
document.getElementById('next-btn').addEventListener('click', nextQuestion);
document.getElementById('prev-btn').addEventListener('click', prevQuestion);

// Load quiz when page loads
document.addEventListener('DOMContentLoaded', loadQuiz);
</script>
{% endblock %}
