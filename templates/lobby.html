{% extends "base.html" %}

{% block title %}Lobby - Listening History Quiz{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="text-center mb-4">
            <h2><i class="fas fa-users me-2"></i>Game Lobby</h2>
            <p class="text-muted">Share the QR code below for others to join!</p>
        </div>

        <div class="row">
            <!-- QR Code Section -->
            <div class="col-md-5 mb-4">
                <div class="card shadow-lg h-100">
                    <div class="card-body text-center p-4">
                        <h4 class="mb-3">Lobby Code</h4>
                        <div class="display-4 font-weight-bold text-primary mb-3">{{ lobby.id }}</div>
                        
                        <div class="mb-3">
                            <img src="{{ qr_code }}" alt="QR Code" class="img-fluid" style="max-width: 300px;">
                        </div>
                        
                        <p class="text-muted small mb-2">Scan with your phone to join</p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="join-url" value="{{ join_url }}" readonly>
                            <button class="btn btn-outline-secondary" onclick="copyJoinUrl()">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Participants Section -->
            <div class="col-md-7 mb-4">
                <div class="card shadow-lg h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Players (<span id="participant-count">{{ lobby.participant_count }}</span>)</h5>
                    </div>
                    <div class="card-body">
                        <div id="participants-list">
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-spinner fa-spin me-2"></i>Loading participants...
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-success btn-lg w-100" id="start-game-btn" onclick="startGame()" disabled>
                                <i class="fas fa-play me-2"></i>Start Game
                            </button>
                            <p class="text-muted small text-center mt-2 mb-0">
                                <span id="start-hint">Waiting for players to join...</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const lobbyId = '{{ lobby.id }}';
let pollInterval;

function updateLobbyStatus() {
    fetch(`/api/lobby/${lobbyId}/status`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error:', data.error);
                return;
            }
            
            const participants = data.participants || [];
            const participantCount = participants.length;
            
            // Update count
            document.getElementById('participant-count').textContent = participantCount;
            
            // Update participants list
            const participantsList = document.getElementById('participants-list');
            if (participants.length === 0) {
                participantsList.innerHTML = '<div class="text-center text-muted py-3">No players joined yet. Share the QR code above!</div>';
            } else {
                let html = '<div class="list-group">';
                participants.forEach((p, index) => {
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${p.game_name || 'Player ' + (index + 1)}</strong>
                                <small class="text-muted d-block">Joined ${new Date(p.joined_at).toLocaleTimeString()}</small>
                            </div>
                            ${p.score > 0 ? `<span class="badge bg-success">Score: ${p.score}</span>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
                participantsList.innerHTML = html;
            }
            
            // Update start button
            const startBtn = document.getElementById('start-game-btn');
            const startHint = document.getElementById('start-hint');
            
            if (data.lobby.status === 'active') {
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-check me-2"></i>Game Started!';
                startHint.textContent = 'Game is in progress...';
                // Redirect to quiz page
                setTimeout(() => {
                    window.location.href = `/quiz?lobby=${lobbyId}`;
                }, 2000);
            } else if (participantCount >= 1) {
                startBtn.disabled = false;
                startHint.textContent = `Ready to start with ${participantCount} player(s)!`;
            } else {
                startBtn.disabled = true;
                startHint.textContent = 'Waiting for players to join...';
            }
        })
        .catch(error => {
            console.error('Error fetching lobby status:', error);
        });
}

function startGame() {
    if (!confirm('Start the game now? All players will begin the quiz.')) {
        return;
    }
    
    fetch(`/api/lobby/${lobbyId}/start`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            // Game started, redirect to quiz
            window.location.href = `/quiz?lobby=${lobbyId}`;
        }
    })
    .catch(error => {
        console.error('Error starting game:', error);
        alert('Failed to start game. Please try again.');
    });
}

function copyJoinUrl() {
    const input = document.getElementById('join-url');
    input.select();
    document.execCommand('copy');
    
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
    setTimeout(() => {
        btn.innerHTML = originalText;
    }, 2000);
}

// Poll for lobby updates every 2 seconds
pollInterval = setInterval(updateLobbyStatus, 2000);
updateLobbyStatus(); // Initial load

// Clean up on page unload
window.addEventListener('beforeunload', () => {
    if (pollInterval) {
        clearInterval(pollInterval);
    }
});
</script>
{% endblock %}
